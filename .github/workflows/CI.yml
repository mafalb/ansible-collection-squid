# vim: set ft=yaml ts=2 expandtab:
---

name: CI

on:  # yamllint disable-line rule:truthy

  push:
    branches:
    - '**'
    tags-ignore:
    - '*'

  schedule:
  - cron: '40 11 * * 5'

jobs:

  CI:

    # old cgroup v1 systems cannot run with githubs ubuntu-22.04
    # need to set kernel parameters
    #
    # systemd.unified_cgroup_hierarchy=0
    # systemd.legacy_systemd_cgroup_controller=1
    #
    runs-on: ubuntu-20.04

    strategy:

      fail-fast: false

      matrix:

        target:
        - c8s
        - alma8
        - rocky8
        - centos7
        - ubuntu20
        - ubuntu22

        include:

        - target: c8s
          image: quay.io/centos/centos:stream8

        - target: alma8
          image: quay.io/almalinux/almalinux:8

        - target: rocky8
          image: quay.io/rockylinux/rockylinux:8

        - target: centos7
          image: quay.io/centos/centos:7

        - target: ubuntu20
          image: docker.io/ubuntu:focal

        - target: ubuntu22
          image: docker.io/ubuntu:jammy

    env:
      CI_IMAGE: ${{ matrix.image }}
      CI_HOSTNAME: ci-${{ matrix.target }}
      CI_TARGET: ${{ matrix.target }}
      PY_COLORS: 1
      ANSIBLE_FORCE_COLOR: 1

    steps:

      - name: setup python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Checkout workflows
        uses: actions/checkout@v4
        with:
          repository: mafalb/workflows
          path: workflows
          ref: f-ansiblecollection  # FIX

      - name: Install Ansible
        uses: ./workflows/.github/actions/installansible
        with:
          extra_packages: 'molecule-plugins[docker,podman],molecule'
          ref: dev  # FIX

      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: ansible_collections/mafalb/squid

      - name: molecule default scenario
        working-directory: ansible_collections/mafalb/squid
        run: |
          source ~/.virtualenvs/ansible/bin/activate
          molecule -c molecule/resources/molecule.yml -e ".env-$CI_TARGET.yml" test

      - name: molecule custom_template scenario
        working-directory: ansible_collections/mafalb/squid
        run: |
          source ~/.virtualenvs/ansible/bin/activate
          molecule -c molecule/resources/molecule.yml -e ".env-$CI_TARGET.yml" test -s custom_template

      - name: molecule squid_cfg scenario
        working-directory: ansible_collections/mafalb/squid
        run: |
          source ~/.virtualenvs/ansible/bin/activate
          molecule -c molecule/resources/molecule.yml -e ".env-$CI_TARGET.yml" test -s squid_cfg
...
